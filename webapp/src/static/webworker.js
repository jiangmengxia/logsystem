!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=2)}([function(e,t,n){(function(t){var n;"undefined"!=typeof window?window:void 0!==t||"undefined"!=typeof self&&self,n=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t),n.d(t,"InDB",(function(){return s})),n.d(t,"InDBStore",(function(){return c}));var r=n(1);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}var s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=t.name,o=t.version,u=void 0===o?1:o,a=t.stores,s=!n;n||(n="__indb__"),a&&Array.isArray(a)&&a.length||(a=[{name:"__indb__",isKv:!0}]),this.name=n,this.version=u,this.stores=a;var c=indexedDB.open(n,u);if(c.onupgradeneeded=function(e){var t=e.target.result,n=Array.from(t.objectStoreNames),r=[];a.forEach((function(o){var i=null;if(n.indexOf(o.name)>-1)i=e.target.transaction.objectStore(o.name);else{var u=o.isKv?"key":o.keyPath,a=!o.isKv&&o.autoIncrement;i=t.createObjectStore(o.name,{keyPath:u,autoIncrement:a})}var s=i.indexNames;s&&s.length&&Array.from(s).forEach((function(e){return i.deleteIndex(e)})),o.indexes&&o.indexes.length&&o.indexes.forEach((function(e){i.createIndex(e.name,e.keyPath||e.name,{unique:e.unique,multiEntry:Array.isArray(e.keyPath)})})),r.push(o.name)})),n&&n.forEach((function(e){-1===r.indexOf(e)&&t.deleteObjectStore(e)}))},c.onblocked=function(e){console.error(Object(r.a)(new Error("indexedDB "+n+" is blocked")))},this.using={},s)return this.use(n)}return a(e,[{key:"connect",value:function(){var e=this;return new Promise((function(t,n){var o=indexedDB.open(e.name,e.version);o.onerror=function(e){n(Object(r.a)(e))},o.onsuccess=function(e){t(e.target.result)}}))}},{key:"use",value:function(e){var t=this.stores.find((function(t){return t.name===e}));if(!t)throw new Error("[InDB]: store ".concat(e," is not existing."));if(this.using[e])return this.using[e];var n=new c({db:this,store:t});return t.isKv&&(n.key=function(e){return n.keys().then((function(t){return t&&t[e]}))},n.getItem=function(e){return n.get(e).then((function(e){return e&&e.value}))},n.setItem=function(e,t){return n.put({key:e,value:t})},n.removeItem=function(e){return n.delete(e)}),this.using[e]=n,n}},{key:"close",value:function(){return this.using=null,this.stores=null,this.connect().then((function(e){e.close()}))}}]),e}();s.deleteDatabase=function(e){return new Promise((function(t,n){var r=indexedDB.deleteDatabase(e);r.onsuccess=function(){t()},r.onerror=function(e){n(e)}}))},s.databases=function(){return indexedDB.databases()},t.default=s;var c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=t.store,r=t.db;if("object"!==o(n)||!n.name||"string"!=typeof n.name)throw new Error("[InDBStore]: options.store should be a store config object.");if(!(r instanceof s))throw new Error("[InDBStore]: options.db should be an instanceof InDB.");this.store=n,this.db=r,this.name=n.name,this.keyPath=n.isKv?"key":n.keyPath}return a(e,[{key:"transaction",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=this.name,r=t?"readwrite":"readonly",o=this.db.connection,i=o?Promise.resolve(o):this.db.connect();return i.then((function(t){e.db.connection=t;var o=t.transaction(n,r),i=function(){e.db.connection=null};return o.oncomplete=i,o.onabort=i,o.onerror=i,o}))}},{key:"objectStore",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.name;return this.transaction(e).then((function(e){return e.objectStore(t)}))}},{key:"cursor",value:function(e){var t=e.index,n=e.range,o=e.direction,i=e.onTouch,u=e.onDone,a=e.onError,s=e.writable,c=void 0!==s&&s;return this.objectStore(c).then((function(e){var s=t?e.index(t):e,c=s.openCursor(n,o);c.onsuccess=function(e){var t=e.target.result;t?i(t,s):u(t,s)},c.onerror=function(e){a(Object(r.a)(e))}}))}},{key:"request",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=n.writable,i=void 0!==o&&o;return new Promise((function(n,o){t.objectStore(i).then((function(t){var i=e(t);i.onsuccess=function(e){var t=e.target.result;n(t)},i.onerror=function(e){o(Object(r.a)(e))}}))}))}},{key:"iterate",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.index,o=n.range,i=n.writable,u=void 0!==i&&i,a=n.direction,s=void 0===a?"next":a;return new Promise((function(n,i){t.cursor({index:r,range:o,writable:u,direction:s,onTouch:function(t,r){e(t,(function(){return t.continue()}),(function(){r.transaction.commit(),n()}))},onDone:function(){n()},onError:function(e){i(e)}})}))}},{key:"batch",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=n.writable,i=void 0===o||o;return this.transaction(i).then((function(n){var o=t.name,i=[],u=n.objectStore(o);return e.forEach((function(e){var t=new Promise((function(t,n){var o=e(u);o.onsuccess=function(e){var n=e.target.result;t(n)},o.onerror=function(e){n(Object(r.a)(e))}}));i.push(t)})),Promise.all(i)}))}},{key:"get",value:function(e){if(!Array.isArray(e))return this.request((function(t){return t.get(e)}));var t=e.map((function(e){return function(t){return t.get(e)}}));return this.batch(t,{writable:!1})}},{key:"keys",value:function(){var e=this.keyPath,t=[];return this.each((function(n){var o=Object(r.b)(n,e);t.push(o)})).then((function(){return t}))}},{key:"all",value:function(){var e=[];return this.each((function(t){e.push(t)})).then((function(){return e}))}},{key:"count",value:function(){return this.request((function(e){return e.count()}))}},{key:"each",value:function(e){return this.iterate((function(t,n){var r=t.value;e(r),n()}))}},{key:"reverse",value:function(e){return this.iterate((function(t,n){var r=t.value;e(r),n()}),{direction:"prev"})}},{key:"some",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Promise((function(r,o){var i,u=[],a=0,s=n,c=n+t;n<0&&(i="prev",t=Math.min(t,-n),c=(s=-(n+t)||0)+t),e.iterate((function(e,t,n){a<s?(a++,t()):a<c?(u.push(e.value),a++,t()):n()}),{direction:i}).then((function(){n<0&&u.reverse(),r(u)})).catch(o)}))}},{key:"first",value:function(){return this.some(1).then((function(e){return e[0]}))}},{key:"last",value:function(){return this.some(1,-1).then((function(e){return e[0]}))}},{key:"find",value:function(e,t){return this.request((function(n){return n.index(e).get(t)}))}},{key:"query",value:function(e,t,n){var o=this,i=function(){switch(n){case">":return IDBKeyRange.lowerBound(t,!0);case">=":return IDBKeyRange.lowerBound(t);case"<":return IDBKeyRange.upperBound(t,!0);case"<=":return IDBKeyRange.upperBound(t);case"%":case"!=":case"in":return;default:return IDBKeyRange.only(t)}}(),u=[];return new Promise((function(a,s){o.cursor({index:e,range:i,onTouch:function(e,o){var i=e.value,a=o.keyPath,s=Object(r.b)(i,a);"!="===n?s!==t&&u.push(i):"%"===n?"string"==typeof s&&s.indexOf(t)>-1&&u.push(i):"in"===n?Array.isArray(t)&&t.indexOf(s)>-1&&u.push(i):u.push(i),e.continue()},onDone:function(){a(u)},onError:function(e){s(e)}})}))}},{key:"select",value:function(e){var t=this.store.indexes||[],n={};t.forEach((function(e){var t=e.name,r=e.keyPath;n[t]=r}));for(var o=[],i=[],u=0,a=e.length;u<a;u++){var s=e[u],c=s.key,l=s.value,f=s.compare,h=s.optional,d=n[c]||c;h?o.push({keyPath:d,value:l,compare:f}):i.push({keyPath:d,value:l,compare:f})}var p=[];return this.each((function(e){(function(e){for(var t=function(e,t,n){if(void 0===e)return!1;switch(n){case">":return e>t;case">=":return e>=t;case"<":return e<t;case"<=":return e<=t;case"!=":return e!==t;case"%":return"string"==typeof e&&e.indexOf(t)>-1;case"in":return Array.isArray(t)&&t.indexOf(e)>-1;default:return e===t}},n=0,u=i.length;n<u;n++){var a=i[n],s=a.keyPath,c=a.value,l=a.compare;if(!t(Object(r.b)(e,s),c,l))return!1}for(var f=0,h=o.length;f<h;f++){var d=o[f],p=d.keyPath,v=d.value,y=d.compare;if(t(Object(r.b)(e,p),v,y))return!0}return!1})(e)&&p.push(e)})).then((function(){return p}))}},{key:"add",value:function(e,t){if(Array.isArray(e)){var n=e;if(n.length<2)return this.add(e[0],t);var r=n.map((function(e){return function(n){return n.add(e,t)}}));return this.batch(r)}return e?this.request((function(n){return n.add(e,t)}),{writable:!0}):Promise.resolve()}},{key:"put",value:function(e,t){if(Array.isArray(e)){var n=e;if(n.length<2)return this.put(n[0],t);var r=n.map((function(e){return function(n){return n.put(e,t)}}));return this.batch(r)}return e?this.request((function(n){return n.put(e,t)}),{writable:!0}):Promise.resolve()}},{key:"delete",value:function(e){if(Array.isArray(e)){var t=e;if(t.length<2)return this.delete(t[0]);var n=t.map((function(e){return function(t){return t.delete(e)}}));return this.batch(n)}return e?this.request((function(t){return t.delete(e)}),{writable:!0}):Promise.resolve()}},{key:"remove",value:function(e){var t=this.keyPath;if(Array.isArray(e)){var n=e;if(n.length<2)return this.remove(n[0]);var o=n.map((function(e){var n=Object(r.b)(e,t);return function(e){return e.delete(n)}}));return this.batch(o)}if(!e)return Promise.resolve();var i=Object(r.b)(e,t);return i?this.delete(i):Promise.resolve()}},{key:"clear",value:function(){return this.request((function(e){return e.clear()}),{writable:!0})}}]),e}()},function(e,t,n){"use strict";function r(e,t){if(!Array.isArray(t)){var n=function(e){return e.toString().split(/\.|\[|\]/).filter((function(e){return!!e}))}(t);if(!n.length)return e;for(var o=e,i=0,u=n.length;i<u;i++){var a=n[i];if(void 0===o[a])return;o=o[a]}return o}for(var s=0,c=t.length;s<c;s++){var l=r(e,t[s]);if(void 0!==l)return l}}function o(e){var t=e.message;return e.message=-1===t.indexOf("[IndexedDB]")?"[IndexedDB]: "+t:t,e}n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return o}))}])},e.exports=n()}).call(this,n(1))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";n.r(t);var r=n(0),o=n.n(r);function i(e){var t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return t+"-"+(n<10?"0"+n:n)+"-"+(r<10?"0"+r:r)}var u,a,s=function(){};!function(e){e.GET="GET",e.POST="POST"}(u||(u={})),function(e){e[e.SUCCESS=1]="SUCCESS",e[e.FAILED=0]="FAILED"}(a||(a={}));var c,l=function(){return(l=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},f=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function u(e){try{s(r.next(e))}catch(e){i(e)}}function a(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,a)}s((r=r.apply(e,t||[])).next())}))},h=function(e,t){var n,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},d=function(){function e(e,t){var n=this;void 0===e&&(e="jzx_log_db"),void 0===t&&(t=s),this.db=null,this.dbError=null,this.tbLog=null;var r=new o.a({name:e||"jzx_log_db",version:1,itemDuration:6048e5,stores:[{name:"jzx_log_immediate_table",keyPath:"id",autoIncrement:!0,indexes:[{name:"logReportName",unique:!1,keyPath:"logReportName"},{name:"logCreateTime",unique:!1,keyPath:"logCreateTime"}]},{name:"jzx_log_table",keyPath:"id",autoIncrement:!0,indexes:[{name:"logReportName",unique:!1,keyPath:"logReportName"},{name:"logCreateTime",unique:!1,keyPath:"logCreateTime"}]},{name:"jzx_log_day_table",autoIncrement:!0,keyPath:"logDay",indexs:[{name:"logDay",unique:!0,keyPath:"logDay"}]},{name:"log_last_removed_day_table",autoIncrement:!0,keyPath:"last_removed_day",indexs:[{name:"last_removed_day",unique:!0,keyPath:"last_removed_day"}]}]});r.connect().then((function(e){n.db=r,t&&t()}))}return e.prototype.judgeDBIsConnected=function(){if(null===this.db)return console.error("db is not avalable"),{ret:a.FAILED}},e.prototype.addLogItem=function(e){return f(this,void 0,void 0,(function(){var t,n,r,o,u,s;return h(this,(function(c){switch(c.label){case 0:return this.judgeDBIsConnected(),t=i(new Date),n=this.db.use("jzx_log_table"),!0===e.isImmediate?[2,this.addLogItemImmediate(e)]:(r=this.db.use("jzx_log_day_table"),[4,n.add(l((u={},u.logReportName=t,u.logCreateTime=Date.now(),u),e))]);case 1:return o=c.sent(),r&&r.put(((s={}).logDay=t,s)),[2,{ret:a.SUCCESS,data:{id:o}}]}}))}))},e.prototype.addLogItems=function(e){return f(this,void 0,void 0,(function(){var t,n,r,o,u,s;return h(this,(function(c){switch(c.label){case 0:return console.log("addLogItems存储多条日志",e),this.judgeDBIsConnected(),t=i(new Date),n=this.db.use("jzx_log_table"),r=this.db.use("jzx_log_day_table"),o=e.map((function(e){return function(n){var r;return n.add(l(((r={}).logReportName=t,r.logCreateTime=Date.now(),r),e))}})),[4,n.batch(o)];case 1:return u=c.sent(),r&&r.put(((s={}).logDay=t,s)),[2,{ret:a.SUCCESS,data:{ids:u}}]}}))}))},e.prototype.getLogsByReportName=function(e){return f(this,void 0,void 0,(function(){var t,n;return h(this,(function(r){switch(r.label){case 0:return this.judgeDBIsConnected(),t=this.db.use("jzx_log_table"),"String"!==e.constructor.name?[3,2]:[4,t.query("logReportName",e)];case 1:return[2,r.sent()];case 2:return"Array"!==e.constructor.name?[3,4]:(n=e.map((function(e){return{key:"logReportName",value:e,optional:!0}})),[4,t.select(n)]);case 3:return[2,r.sent()];case 4:return[2]}}))}))},e.prototype.getAllLogDays=function(){return f(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return this.judgeDBIsConnected(),[4,this.db.use("jzx_log_day_table").all()];case 1:return[2,e.sent()||[]]}}))}))},e.prototype.incrementalDeleteByDay=function(e){return f(this,void 0,void 0,(function(){var t,n,r,o;return h(this,(function(i){switch(i.label){case 0:return this.judgeDBIsConnected(),t=this.db.use("jzx_log_table"),n=this.db.use("jzx_log_day_table"),[4,this.getLogsByReportName(e)];case 1:return(r=i.sent())?(o=r.map((function(e){return function(t){return t.delete(e.id)}})),[4,t.batch(o)]):[3,3];case 2:i.sent(),i.label=3;case 3:return[4,n.delete(e)];case 4:return i.sent(),[2]}}))}))},e.prototype.incrementalDeleteLogs=function(e,t){return f(this,void 0,void 0,(function(){var n,r,o;return h(this,(function(i){switch(i.label){case 0:return this.judgeDBIsConnected(),n=this.db.use("jzx_log_table"),r=this.db.use("jzx_log_day_table"),e&&e.length>0?(o=e.map((function(e){return function(t){return t.delete(e.id)}})),[4,n.batch(o)]):[3,2];case 1:i.sent(),i.label=2;case 2:return t&&t.length>0?(o=t.map((function(e){return function(t){return t.delete(e.logDay)}})),[4,r.batch(o)]):[3,4];case 3:i.sent(),i.label=4;case 4:return[2,{ret:a.SUCCESS}]}}))}))},e.prototype.updateDayRemovedInfo=function(e){return f(this,void 0,void 0,(function(){var t,n,r;return h(this,(function(o){switch(o.label){case 0:return[4,(t=this.db.use("log_last_removed_day_table")).last()];case 1:return(n=o.sent())?(n.last_removed_day=e,[4,t.put(n)]):[3,3];case 2:return[2,o.sent()];case 3:return[4,t.put((r={},r.last_removed_day=e,r))];case 4:return[2,o.sent()]}}))}))},e.prototype.getDayRemovedDayInfo=function(){return f(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:return[4,this.db.use("log_last_removed_day_table").last()];case 1:return(e=t.sent())?[2,e.last_removed_day]:[2,null]}}))}))},e.prototype.addLogItemImmediate=function(e){return f(this,void 0,void 0,(function(){var t,n,r;return h(this,(function(o){switch(o.label){case 0:return t=this.db.use("jzx_log_immediate_table"),n=i(new Date),[4,t.add(l((r={},r.logReportName=n,r.logCreateTime=Date.now(),r),e))];case 1:return[2,o.sent()]}}))}))},e.prototype.addLogItemsImmediate=function(e){return f(this,void 0,void 0,(function(){var t,n,r,o;return h(this,(function(u){switch(u.label){case 0:return t=this.db.use("jzx_log_immediate_table"),n=i(new Date),r=e.map((function(e){return function(t){var r;return t.add(l(((r={}).logReportName=n,r.logCreateTime=Date.now(),r),e))}})),[4,t.batch(r)];case 1:return[2,{ret:(o=u.sent())?a.SUCCESS:a.FAILED,data:{ids:o}}]}}))}))},e.prototype.getLogItemImmediate=function(e){return f(this,void 0,void 0,(function(){return h(this,(function(t){switch(t.label){case 0:return[4,this.db.use("jzx_log_immediate_table").get(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.getLogItemsImmediate=function(e){return f(this,void 0,void 0,(function(){var t;return h(this,(function(n){switch(n.label){case 0:return t=e.map((function(e){return function(t){return t.get(e)}})),[4,this.db.use("jzx_log_immediate_table").batch(t)];case 1:return[2,n.sent()]}}))}))},e.prototype.incrementDeleteLogInImmediateTable=function(e){return f(this,void 0,void 0,(function(){return h(this,(function(t){switch(t.label){case 0:return this.judgeDBIsConnected(),[4,this.db.use("jzx_log_immediate_table").delete(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.incrementDeleteLogsInImmediateTable=function(e){return f(this,void 0,void 0,(function(){var t;return h(this,(function(n){switch(n.label){case 0:return this.judgeDBIsConnected(),t=e.map((function(e){return function(t){return t.delete(e)}})),[4,this.db.use("jzx_log_immediate_table").batch(t)];case 1:return n.sent(),[2,{ret:a.SUCCESS}]}}))}))},e.prototype.getAllImediateLogs=function(){return f(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this.db.use("jzx_log_immediate_table").all()];case 1:return[2,e.sent()]}}))}))},e.prototype.deleteImediateLog=function(e){return f(this,void 0,void 0,(function(){var t,n;return h(this,(function(r){switch(r.label){case 0:return t=this.db.use("jzx_log_immediate_table"),e&&e.length>0?(n=e.map((function(e){return function(t){return t.delete(e.id)}})),[4,t.batch(n)]):[3,2];case 1:return[2,r.sent()];case 2:return[2]}}))}))},e}(),p=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function u(e){try{s(r.next(e))}catch(e){i(e)}}function a(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,a)}s((r=r.apply(e,t||[])).next())}))},v=function(e,t){var n,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},y=function(){function e(){this.queue=[],this.operationRunning=!1,this.queue=[]}return e.prototype.loganOperationsRecursion=function(){return p(this,void 0,void 0,(function(){var e,t,n;return v(this,(function(r){switch(r.label){case 0:if(!(this.queue.length>0)||this.operationRunning)return[3,5];e=this.queue.shift(),this.operationRunning=!0,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,e.asyncF()];case 2:return t=r.sent(),e.resolveF(t),[3,4];case 3:return n=r.sent(),e.rejectF(n),[3,4];case 4:return this.operationRunning=!1,this.loganOperationsRecursion(),[3,0];case 5:return[2]}}))}))},e.prototype.invokeInQueue=function(e){return p(this,void 0,void 0,(function(){var t=this;return v(this,(function(n){return[2,new Promise((function(n,r){t.queue.push({asyncF:e,resolveF:n,rejectF:r}),t.loganOperationsRecursion()}))]}))}))},e}(),g=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function u(e){try{s(r.next(e))}catch(e){i(e)}}function a(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,a)}s((r=r.apply(e,t||[])).next())}))},b=function(e,t){var n,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},m=function(e,t,n,r,o){return g(void 0,void 0,void 0,(function(){return b(this,(function(i){return[2,new Promise((function(i,u){!function(e){console.log("XHROpts ---",e.url);var t=new XMLHttpRequest;if(t.open(e.type||"GET",e.url,!0),t.addEventListener("error",(function(t){e.fail&&e.fail("Request failed, error:"+t)})),t.addEventListener("timeout",(function(t){e.fail&&e.fail("Request timeout, error:"+t)})),t.withCredentials=e.withCredentials,t.onreadystatechange=function(){if(4===t.readyState){var n=t.status;200==n?e.success&&e.success(t.responseText):e.fail&&e.fail("Request failed, status: "+n+", responseText: "+t.responseText)}},"POST"===e.type){if(e.headers)for(var n in e.headers)t.setRequestHeader(n,e.headers[n]);t.send(e.data)}else t.send()}({url:e,type:r||"GET",data:t,withCredentials:!!n,headers:o,success:function(e){i({ret:a.SUCCESS,data:e})},fail:function(e){console.log("error XHR",new Error(e||"error")),i({ret:a.FAILED,error:e||"Request failed"})}})}))]}))}))},w=function(){return(w=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},_=function(e){console.log("设置config为",e),e?e.url?c=w({},e):console.error("url must be provided"):console.error("请配置config")},x=function(e){return console.log("获取config key "+e,c[e]),c?c[e]:null},k=function(){return console.log("获取config为",c),c},D=function(){return(D=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},I=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function u(e){try{s(r.next(e))}catch(e){i(e)}}function a(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,a)}s((r=r.apply(e,t||[])).next())}))},j=function(e,t){var n,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},S=function(){function e(){this.duration=3e3,this.repeat=2,console.log("LogReporter 获取log_config",k()),this.repeat=x("repeat")||2,this.duration=x("duration")||3e3,this.handleResponse=x("handleResponse"),this.handleRequest=x("handleRequest")}return e.prototype.report=function(e){var t=e.data;return I(this,void 0,void 0,(function(){var e,n,r,o,i,u=this;return j(this,(function(s){switch(s.label){case 0:return e=k(),n=e.url,r=e.method,o=e.headers,i=void 0===o?{}:o,!1===/^((https:\/\/)|(http:\/\/))/.test(n)?(console.error("上报的url:"+n+"不符合域名格式,请重新配置"),[2,{ret:a.FAILED,error:n+"不符合域名格式"}]):[4,this.retry((function(){return m(n,JSON.stringify(u.handleRequest(t)),!1,r||"get",D({"Content-Type":"application/json"},i))}),this.repeat)];case 1:return[2,s.sent()]}}))}))},e.prototype.retry=function(e,t){return I(this,void 0,void 0,(function(){var n,r,o,i,u=this;return j(this,(function(s){switch(s.label){case 0:return[4,e()];case 1:return(n=s.sent()).ret===a.FAILED?0===t?[2,n]:[2,Promise.resolve(setTimeout((function(){return u.retry(e,Number(t)-1)}),Number(this.duration)))]:(r=this.handleResponse(n.data),o=r.ret,i=r.error,console.log("----------",o,i),[2,{ret:o,error:i}])}}))}))},e}(),P=function(){function e(e){this.operationRunning=!1,this.runStart=!1,this.queue=[],this.logOperate=e}return e.prototype.startOperate=function(){this.runStart=!0,this.operatingRecursion()},e.prototype.operatingRecursion=function(){if(this.runStart&&!this.operationRunning&&this.queue.length>0&&(this.operationRunning=!0,this.queue.length>0)){var e=this.queue.splice(0,this.queue.length);this.logOperate&&this.logOperate(e),this.operationRunning=!1,this.operatingRecursion()}},e.prototype.invokePushQueue=function(e){this.queue.push(e),this.operatingRecursion()},e}(),O=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function u(e){try{s(r.next(e))}catch(e){i(e)}}function a(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,a)}s((r=r.apply(e,t||[])).next())}))},R=function(e,t){var n,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},B=function(){function e(e){var t=this;this.logDB=null,this.logReporter=null,this.logQueue=null,this.today=null,this.dailyRemoved=!1,this.logReporter=new S,this.operationQueue=new y,this.logQueue=new P((function(e){t.operationQueue.invokeInQueue((function(){var n=e.reduce((function(e,t){return!0===t.isImmediate?e.ImLogs.push(t):e.logs.push(t),e}),{ImLogs:[],logs:[]}),r=n.ImLogs,o=n.logs;r.length>0&&t.reportImmediately(r),o.length>0&&t.logDB.addLogItems(o).then((function(e){e.ret,e.data}))}))})),this.today=i(new Date),this.init(e)}return e.prototype.getDB=function(){return this.logDB},e.prototype.init=function(e){return O(this,void 0,void 0,(function(){var t=this;return R(this,(function(n){return this.logDB=new d(x("DBName"),(function(){return O(t,void 0,void 0,(function(){var t=this;return R(this,(function(n){return e&&e(),this.dailyRemoved?(console.log("开始init"),this.logQueue.startOperate()):this.reportDaily().then((function(){t.logQueue.startOperate()})),[2]}))}))})),[2]}))}))},e.getInstance=function(t){return null===this.instance_&&(this.instance_=new e(t)),this.instance_},e.prototype.regist=function(e){return O(this,void 0,void 0,(function(){return R(this,(function(t){return console.log("--regist- && -invokePushQueue-"),[2,this.logQueue.invokePushQueue(e)]}))}))},e.prototype.reportImmediateLogsUnReported=function(){return O(this,void 0,void 0,(function(){var e;return R(this,(function(t){switch(t.label){case 0:return[4,this.logDB.getAllImediateLogs()];case 1:return(e=t.sent()).length>0?(this.reportLogs(e,(function(){})),[2]):[2]}}))}))},e.prototype.reportDaily=function(){return O(this,void 0,void 0,(function(){var e=this;return R(this,(function(t){switch(t.label){case 0:return[4,this.operationQueue.invokeInQueue((function(){return e.reportDaily_()}))];case 1:return[2,t.sent()]}}))}))},e.prototype.reportDaily_=function(){return O(this,void 0,void 0,(function(){var e,t,n=this;return R(this,(function(r){switch(r.label){case 0:return[4,this.logDB.getAllLogDays()];case 1:return e=r.sent()||[],[4,this.logDB.getLogsByReportName(e.map((function(e){return e.logDay})))];case 2:return t=r.sent()||[],[2,this.reportLogs(t,(function(){return O(n,void 0,void 0,(function(){return R(this,(function(n){switch(n.label){case 0:return[4,this.logDB.incrementalDeleteLogs(t,e)];case 1:return n.sent(),this.dailyRemoved=!0,this.logDB.updateDayRemovedInfo(this.today),console.info("Daily Report LOGs  has  success"),[2]}}))}))}))]}}))}))},e.prototype.reportLogs=function(e,t){return O(this,void 0,void 0,(function(){var n;return R(this,(function(r){switch(r.label){case 0:return 0===e.length?[2]:[4,this.logReporter.report({data:e})];case 1:return n=r.sent(),console.log("reportDaily callback data",n),n.ret===a.SUCCESS?t&&t(n):console.error(n.error),[2]}}))}))},e.prototype.reportImmediately=function(e){return O(this,void 0,void 0,(function(){var t=this;return R(this,(function(n){return 0===e.length||this.logDB.addLogItemsImmediate(e).then((function(e){var n=e.ret,r=e.data;return O(t,void 0,void 0,(function(){var e,t=this;return R(this,(function(o){switch(o.label){case 0:return n!==a.SUCCESS?[3,2]:(console.log("存储日志记录成功",r.ids),[4,this.logDB.getLogItemsImmediate(r.ids)]);case 1:e=o.sent(),this.reportLogs(e,(function(){return O(t,void 0,void 0,(function(){return R(this,(function(e){switch(e.label){case 0:return[4,this.logDB.incrementDeleteLogsInImmediateTable(r.ids)];case 1:return e.sent(),[2]}}))}))})),o.label=2;case 2:return[2]}}))}))})),[2]}))}))},e.prototype.errorHandler=function(){},e.instance_=null,e}(),E=null;onmessage=function(e){var t=e.data,n=t.v,r=t.log,o=t.config;if("init"===n)console.log("config----onmessage",JSON.parse(o)),o?(_(o),E=B.getInstance((function(){console.log("webworker logManger repared")}))):console.error("请先配置config!");else if("log"===n){if(null===E)return void console.error("webworker logManger hasnot repared");E.regist(r)}}}]);